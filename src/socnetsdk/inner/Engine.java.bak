package socnetsdk.inner;

import java.io.File;
import java.util.ArrayList;
import java.util.logging.Level;
//import org.openqa.selenium.By;
//import org.openqa.selenium.WebDriver;
//import org.openqa.selenium.WebElement;
//
//import org.openqa.selenium.chrome.ChromeDriverService;
//import org.openqa.selenium.chrome.ChromeOptions;
//import org.openqa.selenium.remote.DesiredCapabilities;
//import org.openqa.selenium.remote.RemoteWebDriver;

import socnetsdk.Application;
import socnetsdk.URLSources;
import socnetsdk.beans.Account;
import socnetsdk.beans.Node;
import socnetsdk.beans.Post;
import socnetsdk.beans.SocialMedia;
import socnetsdk.inner.frames.MainWindow;

/**
 *
 * @author @FgroupIndonesia.com
 */
public class Engine {

//    WebDriver driver = null;
//    DesiredCapabilities capabilities = null;
//    ChromeDriverService service = null;
    
    final int WAITING_TIME = 10000; // 10seconds
    final int WAITING_CLICK_TIME = 4000; // 4seconds
    int currentWaitingTime = 0;
    boolean lagiNunggu = true;
    boolean killOnceDone = false;
    String remoteDebuggingAddress = "localhost:9222";
    String fileChromeDriver = "chromedriver.exe";

    
    ArrayList<Account> dataUsers;

    int minRange, maxRange;

    MainWindow browserFrame = new MainWindow();

    public Engine() {

        prepareStuff();

        //System.setProperty("webdriver.chrome.driver", "C:\\chromedriver.exe");
    }

    private void prepareStuff() {

        //killAllChromeDrivers();
        dataUsers = new ArrayList();

        browserFrame.visit("www.fgroupindonesia.com");

    }

    private void runningService() {

        try {

            service = new ChromeDriverService.Builder()
                    .usingDriverExecutable(new File(Application.Path(fileChromeDriver)))
                    .usingAnyFreePort()
                    .build();
            service.start();

            System.out.println("Chromedriver berlokasi di " + Application.Path(fileChromeDriver));
        } catch (Exception ex) {
            Logger.writeError("Error at Engine constructor!");
        }

        ChromeOptions options = new ChromeOptions();
        options.setExperimentalOption("debuggerAddress", remoteDebuggingAddress);
        options.addArguments("--disable-notifications");
        options.addArguments("--disable-gpu");
        options.addArguments("--disable-software-rasterizer");
        options.addArguments("--disable-dev-shm-usage");
        options.addArguments("--no-sandbox");
        //options.addArguments("--proxy-server='direct://'");
        //options.addArguments("--proxy-bypass-list=*");

        //options.addExtensions(new File("modifyheaders206.crx"));
        capabilities = new DesiredCapabilities();
        capabilities.setCapability(ChromeOptions.CAPABILITY, options);

        System.out.println("Debugging Browser on " + remoteDebuggingAddress);

    }

    private void connectToWebDriver() {

        driver = new RemoteWebDriver(service.getUrl(), capabilities);

    }

    public void addUser(Account masuk) {
        this.dataUsers.add(masuk);
    }

    public void addUsers(Account[] masuk) {
        for (Account satuan : masuk) {
            this.dataUsers.add(satuan);
        }

    }

    private Node createNewData(String key, String val) {
        return new Node(key, val);
    }

    private void killAllChromeDrivers() {

        try {
            Runtime rt = Runtime.getRuntime();
            rt.exec("Taskkill /IM chromedriver.exe /F");
        } catch (Exception ex) {
            Logger.writeError("error at killAllChromeDrivers!");
        }

    }

    private WebElement getElementByName(String nama) {

        // let say we're waiting
        lagiNunggu = true;
        WebElement element = null;

        while (lagiNunggu) {

            try {
                waiting(1000);
                element = driver.findElement(By.name(nama));
            } catch (Exception ex) {
                // when found nothing let's wait another time
                currentWaitingTime += 1000;
                System.err.println("Waiting..." + currentWaitingTime + " ms.");
            }

            if (currentWaitingTime == WAITING_TIME) {
                // exit from waiting task
                lagiNunggu = false;
                currentWaitingTime = 0;
            }

            if (element != null) {
                currentWaitingTime = 0;
                lagiNunggu = false;
            }

        }

        return element;
    }

    private WebElement getElementById(String nama) {
        // let say we're waiting
        lagiNunggu = true;
        WebElement element = null;

        while (lagiNunggu) {

            try {
                waiting(1000);
                element = driver.findElement(By.id(nama));
            } catch (Exception ex) {
                // when found nothing let's wait another time
                currentWaitingTime += 1000;
                System.err.println("Waiting..." + currentWaitingTime + " ms.");
            }

            if (currentWaitingTime == WAITING_TIME) {
                // exit from waiting task
                lagiNunggu = false;
                currentWaitingTime = 0;
            }

            if (element != null) {
                currentWaitingTime = 0;
                lagiNunggu = false;
            }

        }

        return element;
    }

    private WebElement getElementByXPath(String nama) {
        // let say we're waiting
        lagiNunggu = true;
        WebElement element = null;

        while (lagiNunggu) {

            try {
                waiting(1000);
                element = driver.findElement(By.xpath(nama));
            } catch (Exception ex) {
                // when found nothing let's wait another time
                currentWaitingTime += 1000;
                System.err.println("Waiting..." + currentWaitingTime + " ms.");
            }

            if (currentWaitingTime == WAITING_TIME) {
                // exit from waiting task
                lagiNunggu = false;
                currentWaitingTime = 0;
            }

            if (element != null) {
                currentWaitingTime = 0;
                lagiNunggu = false;
            }

        }

        return element;
    }

    private WebElement getElementByCSS(String nama) {
        // let say we're waiting
        lagiNunggu = true;
        WebElement element = null;

        while (lagiNunggu) {

            try {
                waiting(1000);
                element = driver.findElement(By.cssSelector(nama));
            } catch (Exception ex) {
                // when found nothing let's wait another time
                currentWaitingTime += 1000;
                System.err.println("Waiting..." + currentWaitingTime + " ms.");
            }

            if (currentWaitingTime == WAITING_TIME) {
                // exit from waiting task
                lagiNunggu = false;
                currentWaitingTime = 0;
            }

            if (element != null) {
                currentWaitingTime = 0;
                lagiNunggu = false;
            }

        }

        return element;
    }

    private void waiting(int miliseconds) {

        try {
            Thread.sleep(miliseconds);
        } catch (Exception ex) {
            Logger.writeError("error when Waiting()");
        }

    }

    public void loginGoogle(Account akun) {

        driver.get(URLSources.URL_GOOGLEPLUS_LOGIN);

        WebElement username = getElementById("identifierId");

        username.sendKeys(akun.getUsername());

        WebElement nextButton = getElementById("identifierNext");
        nextButton.click();

        waiting(WAITING_CLICK_TIME);

        WebElement pass = getElementByCSS("input[name='password']");

        pass.sendKeys(akun.getPass());

        nextButton = getElementById("passwordNext");
        nextButton.click();

        waiting(WAITING_CLICK_TIME);

    }

    public void postGoogle(Post data) {
        //System.out.println(driver.getCurrentUrl());

        if (driver.getCurrentUrl().equals(URLSources.URL_GOOGLEPLUS_HOME) == false) {

            // visit first
            driver.get(URLSources.URL_GOOGLEPLUS_HOME);

        }

        waiting(WAITING_CLICK_TIME);

        // clicking the textbox
        WebElement textbox = getElementByXPath("//span[contains(text(),'with you')]");
        textbox.click();
        waiting(WAITING_CLICK_TIME);

        WebElement textArea = getElementByCSS("textarea[placeholder*='with you']");
        textArea.clear();
        textArea.sendKeys(data.getText());
        waiting(WAITING_CLICK_TIME);

        if (data.getPicture() != null) {

            WebElement gambarIcon = getElementByCSS("div[data-tooltip='Add photos']");
            gambarIcon.click();
            waiting(WAITING_CLICK_TIME);

            WebElement gambarUpload = getElementByXPath("//div/input[@aria-label=\"Upload photo\"]");
            gambarUpload.sendKeys(data.getPicture().getAbsolutePath());
            // wait until the loading completed
            loadingDiv();

        }

        WebElement postButton = getElementByXPath("//span[text()='Post']");
        postButton.click();
        waiting(WAITING_CLICK_TIME);

    }

    public void loginTwitter(Account akun) {

        driver.get(URLSources.URL_TWITTER_LOGIN);

        WebElement username = getElementByXPath("//input[@name, ‘session[username_or_email]’]");
        username.sendKeys(akun.getUsername());

        WebElement pass = getElementByXPath("//input[@name, ‘session[password]");

        pass.sendKeys(akun.getPass());

        // enter key
        pass.submit();

        waiting(WAITING_CLICK_TIME);

    }

    public void loginFacebook(Account akun) {

        driver.get(URLSources.URL_FACEBOOK_LOGIN);

        WebElement username = getElementById("email");
        username.sendKeys(akun.getUsername());

        WebElement pass = getElementById("pass");
        pass.sendKeys(akun.getPass());

        // enter key
        pass.submit();

        waiting(WAITING_CLICK_TIME);

    }

    public void loginLinkedin(Account akun) {

        driver.get(URLSources.URL_LINKEDIN_LOGIN);

        WebElement username = getElementById("username");
        username.sendKeys(akun.getUsername());

        WebElement pass = getElementById("password");
        pass.sendKeys(akun.getPass());

        // enter key
        pass.submit();

        waiting(WAITING_CLICK_TIME);

    }

    private boolean isPageLoggingPassed(Account akun) {

        if (akun.getSocialMediaCode() == SocialMedia.FACEBOOK && driver.getCurrentUrl().equalsIgnoreCase(URLSources.URL_FACEBOOK_LOGIN)) {
            return false;
        } else if (akun.getSocialMediaCode() == SocialMedia.TWITTER && driver.getCurrentUrl().equalsIgnoreCase(URLSources.URL_TWITTER_LOGIN)) {
            return false;
        } else if (akun.getSocialMediaCode() == SocialMedia.LINKEDIN && driver.getCurrentUrl().equalsIgnoreCase(URLSources.URL_LINKEDIN_LOGIN)) {
            return false;
        } else if (akun.getSocialMediaCode() == SocialMedia.GOOGLE && driver.getCurrentUrl().equalsIgnoreCase(URLSources.URL_GOOGLEPLUS_LOGIN)) {
            return false;
        }

        return true;
    }

    private void loadingDiv() {

        WebElement divLoading = null;
        boolean tunggu = true;

        while (tunggu) {

            // keep waiting
            // when the element is still there
            try {

                divLoading = getElementByCSS("div[data-loadingmessage=\"Loading...\"");
                System.out.println("image belum terupload!");
            } catch (Exception ex) {
                System.out.println("image sudah terupload!");
                tunggu = false;
            }

            waiting(3000);

        }

    }

    private void posting(Account dataAkun) {
        System.out.println("Posting akun " + dataAkun.getUsername() + " di " + dataAkun.getSocialMedia() + " sukses!");
    }

    private boolean loggingFirst(Account dataUser) {
        if (dataUser.getSocialMediaCode() == SocialMedia.ALL) {
            loginGoogle(dataUser);
            loginFacebook(dataUser);
            loginTwitter(dataUser);
            loginLinkedin(dataUser);
        } else if (dataUser.getSocialMediaCode() == SocialMedia.FACEBOOK) {
            loginFacebook(dataUser);
        } else if (dataUser.getSocialMediaCode() == SocialMedia.TWITTER) {
            loginTwitter(dataUser);
        } else if (dataUser.getSocialMediaCode() == SocialMedia.GOOGLE) {
            loginGoogle(dataUser);
        } else if (dataUser.getSocialMediaCode() == SocialMedia.LINKEDIN) {
            loginLinkedin(dataUser);
        }

        System.out.println("Trying to loggin as..." + dataUser.getUsername());
        dataUser.setLogged(isPageLoggingPassed(dataUser));
        return dataUser.isLogged();
    }

    private boolean isLogged(Account dataUser) {
        return dataUser.isLogged();
    }

    public void start() {
        // waiting the browser fully loaded
        while (!browserFrame.isCompleteLoaded()) {
            try {
                // keep looping
                System.out.println("waiting for browser...");
                Thread.sleep(1000);
            } catch (InterruptedException ex) {
                Logger.writeError("error while starting Engine before Browser came up!");
            }
        }

        System.out.println("Browser is ready! Now trying for executing everything...");

        // connecting Selenium with JxBrowser
        runningService();

        //driver = new ChromeDriver(capabilities);
        connectToWebDriver();
        System.out.println("Selenium is now Connected to JXBrowser!");

        // execute everything!
        // lakukan loggin untuk masing-masing akun
        for (Account dataAkun : dataUsers) {
            if (isLogged(dataAkun) == false) {
                if (loggingFirst(dataAkun) == true) {
                    posting(dataAkun);
                }
            }
        }

        if (killOnceDone) {
            System.out.println("Exitting web driver services...done!");
            driver.quit();
            service.stop();
        }
    }

    public void start(boolean autoExit) {
        killOnceDone = autoExit;
        this.start();

    }

    public void start(boolean autoExit, int minInterval, int maxInterval) {
        killOnceDone = autoExit;
        this.minRange = minInterval;
        this.maxRange = maxInterval;

        this.start();

    }

    public void start(int minInterval, int maxInterval) {
        this.minRange = minInterval;
        this.maxRange = maxInterval;

        this.start();

    }

    public void setTimeInterval(int minimalRange, int maximumRange) {

        // set a number in between this numbers
        // as minutes
        this.minRange = minimalRange;
        this.maxRange = maximumRange;

    }

    private int getRandomNumber(int a, int b) {

        double nilaiAcak = Math.random() * b + a;
        return (int) nilaiAcak;

    }

    private int getTimeInterval() {

        // known as miliseconds
        int nilaiAcakBulat = getRandomNumber(this.minRange, this.maxRange) * 1000;

        // multiplication of random number quarter miliseconds
        int pengacakLain = getRandomNumber(minRange, minRange) * 250;

        return (nilaiAcakBulat + pengacakLain);
    }

    public static void main(String[] args) {

//        for (String parameter : args) {
//            if (parameter.contains("-path=") || parameter.contains("-p=")) {
//                // set location path
//                String newLocation = ArgumentParser.getValue(parameter);
//                Application.changePath(newLocation);
//            }
//        }
        Engine coba = new Engine();
//        coba.loginGoogle();

        //coba.postGoogle(new Message("Cobalah gunakan therapy termudah dan terjangkau! Senyum...", new File("D:\\smile1.jpg")));
        //coba.postGoogle(new Message("Terapkan ini, tersenyum kembali... Dan mulailah hari yg lebih baik!", new File("D:\\smile2.jpg")));
        //coba.postGoogle(new Message("Jannah lebih dari ini... Maka bersiaplah!", new File("D:\\firdaus.jpg")));
    }

}
